services:
  ibis-server:
    # Build from local source instead of using pre-built image
    build:
      context: .
      dockerfile: ibis-server/Dockerfile.local
      network: host
    # Uncomment below to use pre-built image from registry
    # image: ghcr.io/canner/wren-engine-ibis:latest
    image: wren-engine-ibis:local
    ports:
      - "8000:8000"
    environment:
      - WREN_ENGINE_ENDPOINT=http://java-engine:8080
    depends_on:
      - java-engine
    volumes:
      - ./etc:/usr/src/app/etc
    restart: unless-stopped

  java-engine:
    # Build from local source - requires JAR file to be built first
    # Run: cd wren-core-legacy && ./mvnw clean install -DskipTests -Dair.check.skip-dependency=true -P exec-jar
    build:
      context: ./wren-core-legacy
      dockerfile: docker/Dockerfile.local
      args:
        # Get version from pom.xml: ./mvnw --quiet help:evaluate -Dexpression=project.version -DforceStdout
        # Or set via: WREN_VERSION=0.21.3-SNAPSHOT docker-compose build
        WREN_VERSION: ${WREN_VERSION:-0.21.3-SNAPSHOT}
      # JAR file should be at: wren-server/target/wren-server-${WREN_VERSION}-executable.jar
    # Uncomment below to use pre-built image from registry
    # image: ghcr.io/canner/wren-engine:latest
    image: wren-engine:local
    ports:
      - "8080:8080"
    volumes:
      - ./etc:/usr/src/app/etc
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
    environment:
      - MAX_HEAP_SIZE=819m
      - MIN_HEAP_SIZE=819m
    restart: unless-stopped

